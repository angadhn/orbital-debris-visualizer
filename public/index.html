<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital Debris Visualization</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.110/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://unpkg.com/satellite.js@4.1.3/dist/satellite.min.js"></script>
    <script>
        // Verify satellite.js loaded
        window.addEventListener('load', () => {
            console.log('Checking satellite.js...');
            console.log('typeof satellite:', typeof satellite);
            if (typeof satellite !== 'undefined') {
                console.log('satellite.js loaded');
                console.log('Available functions:', Object.keys(satellite).slice(0, 10));
            } else {
                console.error('satellite.js NOT loaded!');
            }
        });
    </script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="cesiumContainer"></div>
    
    <div id="controlPanel" class="control-panel">
        <h2>Orbital Debris Visualization</h2>
        
        <div class="control-section">
            <h3>Data Controls</h3>
            <button id="loadDebrisBtn" class="btn btn-primary">Load Debris Data</button>
            <button id="refreshDataBtn" class="btn btn-secondary">Refresh Data</button>
            <div class="info">
                <span id="objectCount">0 objects loaded</span>
            </div>
        </div>

        <div class="control-section">
            <h3>Search & Quick Access</h3>
            <div class="input-group">
                <label>Search by Name or NORAD ID:</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="searchInput" placeholder="e.g., Envisat or 27386" style="flex: 1;">
                    <button id="searchBtn" class="btn btn-small">Search</button>
                </div>
            </div>
            <div class="input-group">
                <label>Quick Access:</label>
                <button id="findEnvisatBtn" class="btn btn-small" style="width: 100%;">Find Envisat (NORAD 27386)</button>
            </div>
            <div id="searchResults" class="results" style="display: none;"></div>
        </div>

        <div class="control-section">
            <h3>Visualization</h3>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="showTrailsCheckbox" checked>
                    Show Motion Trails (all objects)
                </label>
            </div>
            <div class="input-group">
                <label>
                    <input type="checkbox" id="showLabelsCheckbox" checked>
                    Show Labels
                </label>
            </div>
            <div id="entityInfo" class="entity-info" style="display: none; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.7); border-radius: 5px; color: white; font-size: 12px;">
                <!-- Entity info will be displayed here -->
            </div>
        </div>

        <div class="control-section">
            <h3>Filters</h3>
            <div class="input-group">
                <label>Object Type:</label>
                <select id="objectTypeFilter" multiple>
                    <option value="PAYLOAD">Payloads (Satellites)</option>
                    <option value="ROCKET BODY">Rocket Bodies</option>
                    <option value="DEBRIS">Debris</option>
                    <option value="FRAGMENT">Fragments</option>
                    <option value="UNKNOWN">Unknown</option>
                </select>
                <small>Hold Ctrl/Cmd to select multiple</small>
            </div>
            <div class="input-group">
                <label>RCS Size:</label>
                <select id="rcsSizeFilter">
                    <option value="">All Sizes</option>
                    <option value="LARGE">Large (&gt;1m)</option>
                    <option value="MEDIUM">Medium (10cm-1m)</option>
                    <option value="SMALL">Small (1-10cm)</option>
                    <option value="TINY">Tiny (&lt;1cm)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Orbit Type:</label>
                <select id="orbitTypeFilter">
                    <option value="">All Orbits</option>
                    <option value="LEO">LEO (Low Earth Orbit)</option>
                    <option value="MEO">MEO (Medium Earth Orbit)</option>
                    <option value="GEO">GEO (Geostationary)</option>
                    <option value="HEO">HEO (High Earth Orbit)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Max Objects:</label>
                <input type="number" id="maxObjects" value="500" min="50" max="5000" step="50">
            </div>
        </div>

        <div class="control-section">
            <h3>Display Options</h3>
            <label>
                <input type="checkbox" id="showLabels" checked> Show Labels
            </label>
            <label>
                <input type="checkbox" id="showTrails"> Show Motion Trails (all objects)
            </label>
            <label>
                <input type="checkbox" id="showObjectType" checked> Show Object Type in Labels
            </label>
            <div id="entityInfo" class="entity-info" style="display: none; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.7); border-radius: 5px; color: white; font-size: 12px;">
                <!-- Entity info will be displayed here when clicked -->
            </div>
        </div>

        <div class="control-section">
            <h3>Collision Detection</h3>
            <div class="input-group">
                <label>Object IDs (comma-separated):</label>
                <input type="text" id="collisionObjectIds" placeholder="e.g., 25544,25545">
            </div>
            <div class="input-group">
                <label>Time Range (hours):</label>
                <input type="number" id="collisionTimeRange" value="24" min="1" max="168">
            </div>
            <button id="detectCollisionsBtn" class="btn btn-warning">Detect Collisions</button>
            <div id="collisionResults" class="results"></div>
        </div>

        <div class="control-section">
            <h3>Collision Simulation</h3>
            <div class="input-group">
                <label>Object 1 ID:</label>
                <input type="number" id="simObject1" placeholder="NORAD ID">
            </div>
            <div class="input-group">
                <label>Object 2 ID:</label>
                <input type="number" id="simObject2" placeholder="NORAD ID">
            </div>
            <div class="input-group">
                <label>Model:</label>
                <select id="simModel">
                    <option value="nasa">NASA Model</option>
                </select>
            </div>
            <button id="simulateCollisionBtn" class="btn btn-danger">Simulate Collision</button>
            <div id="simulationResults" class="results"></div>
        </div>

        <div class="control-section">
            <h3>Time Controls</h3>
            <div class="time-controls">
                <button id="playBtn" class="btn btn-small">Play</button>
                <button id="pauseBtn" class="btn btn-small">Pause</button>
                <button id="resetBtn" class="btn btn-small">Reset</button>
            </div>
            <div class="info">
                <span id="currentTime"></span>
            </div>
        </div>
    </div>

    <script src="js/apiClient.js"></script>
    <script src="js/visualizer.js"></script>
    <script src="js/collisionViewer.js"></script>
    <script>
        // Initialize visualization
        const visualizer = new DebrisVisualizer('cesiumContainer');
        const collisionViewer = new CollisionViewer(visualizer);
        
        // Load debris data on page load
        document.getElementById('loadDebrisBtn').addEventListener('click', () => {
            visualizer.loadDebris();
        });

        document.getElementById('refreshDataBtn').addEventListener('click', () => {
            visualizer.loadDebris(true);
        });

        document.getElementById('detectCollisionsBtn').addEventListener('click', () => {
            const ids = document.getElementById('collisionObjectIds').value.split(',').map(id => parseInt(id.trim()));
            const hours = parseInt(document.getElementById('collisionTimeRange').value);
            collisionViewer.detectCollisions(ids, hours);
        });

        document.getElementById('simulateCollisionBtn').addEventListener('click', () => {
            const id1 = parseInt(document.getElementById('simObject1').value);
            const id2 = parseInt(document.getElementById('simObject2').value);
            const model = document.getElementById('simModel').value;
            collisionViewer.simulateCollision(id1, id2, model);
        });

        // Display options
        document.getElementById('showLabels').addEventListener('change', (e) => {
            visualizer.setShowLabels(e.target.checked);
        });

        document.getElementById('showTrails').addEventListener('change', (e) => {
            visualizer.setShowTrails(e.target.checked);
        });

        document.getElementById('showObjectType').addEventListener('change', () => {
            visualizer.renderDebris(); // Re-render to update labels
        });

        // Search functionality
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) {
                alert('Please enter a search term');
                return;
            }
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>Searching...</p>';
            
            try {
                const found = await visualizer.searchAndHighlight(searchTerm);
                if (found.length > 0) {
                    resultsDiv.innerHTML = `<h4>Found ${found.length} object(s):</h4>` +
                        found.map(obj => 
                            `<div class="search-result-item">
                                <strong>${obj.name}</strong><br>
                                NORAD ID: ${obj.noradId} | Type: ${obj.objectType}
                            </div>`
                        ).join('');
                } else {
                    resultsDiv.innerHTML = '<p style="color: orange;">No objects found. Make sure you\'ve loaded debris data first.</p>';
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
        
        // Quick access to Envisat
        document.getElementById('findEnvisatBtn').addEventListener('click', async () => {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>Finding Envisat (NORAD 27386)...</p>';
            
            try {
                // First try searching in loaded data
                const found = await visualizer.searchAndHighlight('27386');
                
                if (found.length > 0) {
                    const envisat = found[0];
                    resultsDiv.innerHTML = `
                        <h4>✓ Found Envisat!</h4>
                        <div class="search-result-item">
                            <strong>${envisat.name}</strong><br>
                            NORAD ID: ${envisat.noradId}<br>
                            Type: ${envisat.objectType || 'PAYLOAD'}<br>
                            ${envisat.note ? `<em style="color: orange;">${envisat.note}</em>` : ''}
                        </div>
                        <p style="margin-top: 10px; font-size: 11px; color: #ccc;">
                            Envisat is highlighted in yellow. The camera has flown to its position.
                        </p>
                        <p style="margin-top: 5px; font-size: 10px; color: #999;">
                            Tip: If not found, increase "Max Objects" to at least 30,000 and reload data.
                        </p>
                    `;
                } else {
                    // Try searching by name
                    const foundByName = await visualizer.searchAndHighlight('Envisat');
                    if (foundByName.length > 0) {
                        const envisat = foundByName[0];
                        resultsDiv.innerHTML = `
                            <h4>✓ Found Envisat!</h4>
                            <div class="search-result-item">
                                <strong>${envisat.name}</strong><br>
                                NORAD ID: ${envisat.noradId}<br>
                                Type: ${envisat.objectType || 'PAYLOAD'}
                            </div>
                        `;
                    } else {
                        resultsDiv.innerHTML = `
                            <p style="color: orange;">Envisat (NORAD 27386) not found in loaded data.</p>
                            <p style="font-size: 11px; color: #ccc; margin-top: 10px;">
                                <strong>To find Envisat:</strong><br>
                                1. Set "Max Objects" to at least 30,000<br>
                                2. Click "Load Debris Data"<br>
                                3. Click "Find Envisat" again
                            </p>
                        `;
                    }
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        });
        
        // Allow Enter key to trigger search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // Apply filters when changed
        document.getElementById('objectTypeFilter').addEventListener('change', () => {
            visualizer.loadDebris();
        });
        document.getElementById('rcsSizeFilter').addEventListener('change', () => {
            visualizer.loadDebris();
        });
        document.getElementById('orbitTypeFilter').addEventListener('change', () => {
            visualizer.loadDebris();
        });
        document.getElementById('maxObjects').addEventListener('change', (e) => {
            visualizer.setMaxObjects(parseInt(e.target.value));
            visualizer.loadDebris();
        });
    </script>
</body>
</html>

